# 実装計画書: Issue #0031 - 経過時刻の表示

## Issue概要

横長の棒グラフに、その日の稼働時間がわかるようにする機能を実装します。

**要件:**
- タイムカードを見て、その日合計で何時間稼働しているかを計算
- 棒グラフの、その時間のところに縦棒を表示する
- 稼働が全くない場合でも合計稼働時間は0として、特別な処理はしない

## 既存コードの調査結果

### タイムカード機能の仕組み

**データ構造:**
- `TimecardData`: `{ [date: string]: TimecardEntry[] }` の形式
- `TimecardEntry`: `type: 'start' | 'end'` と `time: string (YYYY-MM-DD HH:mm:ss形式)` を持つ
- 例: `{ "2024-10-18": [{ type: "start", time: "2024-10-18 09:00:00" }, { type: "end", time: "2024-10-18 18:00:00" }] }`

**Model層:**
- `src/models/TimecardEntry.ts`: 1つのタイムカードエントリのエンティティ
- `src/models/TimecardRepository.ts`: タイムカードデータのコレクション管理

**Controller層:**
- `src/hooks/useTimecard.ts`: タイムカードの状態管理とIPC通信

### 棒グラフ（TaskExecutionStackBar）の仕組み

**View層:**
- `src/components/TaskExecutionStackBar.tsx`: Todoの実行時間を積み上げ棒グラフで表示するコンポーネント
- 現在、Todoの実行時間のみを表示している
- 横長の棒グラフで、各Todoの実行時間をセグメントとして表示
- 時間目盛（hourMarkers）を表示

**Model層:**
- `src/utils/taskExecutionTime.ts`: 棒グラフの表示ロジックを提供
  - `calculateStackBarDisplay()`: 棒グラフの表示設定を計算
  - `StackBarDisplayConfig`: セグメント、合計時間、表示最大時間、時間目盛の情報を含む

**CSS:**
- `src/components/TaskExecutionStackBar.css`: 棒グラフのスタイル定義
- `.stackbar-scale-marker`: 時間目盛のマーカー用のスタイルが既に存在

### 統合箇所

**DateGroupedTodoList:**
- `src/components/DateGroupedTodoList.tsx`: 日付ごとにグループ化されたTodoリストを表示
- 各日付グループに`TaskExecutionStackBar`を表示している（130行目）
- `useTimecard()`フックでタイムカードデータを取得している（App.tsxで取得済み）

**App.tsx:**
- `useTodos()`と`useTimecard()`の両方を使用
- `DateGroupedTodoList`にはtodosのみを渡している
- タイムカードデータはtimecardDataとして保持されているが、DateGroupedTodoListには渡されていない

## 実装方針

### 基本アプローチ

MVCアーキテクチャに従い、以下のレイヤーで実装を行います:

1. **Model層**: タイムカードから稼働時間を計算するロジックを追加
2. **View層**: 棒グラフに稼働時間を示す縦棒を表示

### レイヤー別の実装内容

#### 1. Model層: タイムカードの稼働時間計算ロジック

**ファイル:** `src/models/TimecardRepository.ts`

**追加する関数:**
- `calculateWorkingTimeForDate(data: TimecardData, date: string): number`
  - 指定日付の稼働時間を分単位で計算
  - タイムカードエントリをペアで処理（start → end）
  - 稼働時間 = endの時刻 - startの時刻の合計
  - ペアになっていないstartは無視（未完了の稼働として扱わない）
  - 稼働がない場合は0を返す

**処理ロジック:**
1. 指定日付のTimecardEntry配列を取得
2. エントリが存在しない場合は0を返す
3. エントリを順番に走査し、startとendのペアを見つける
4. 各ペアの時間差（分単位）を計算して合計
5. 合計稼働時間（分）を返す

**テストファイル:** `src/models/TimecardRepository.test.ts`

テストケースを追加:
- 稼働がない場合は0を返す
- 1つのstart-endペアで正しく計算できる
- 複数のstart-endペアで合計を計算できる
- ペアになっていないstartは無視する
- エントリが存在しない日付では0を返す

#### 2. View層: Controller層でタイムカードデータを受け取る

**ファイル:** `src/components/DateGroupedTodoList.tsx`

**追加するprops:**
- `timecardData: TimecardData`を追加

**ファイル:** `src/App.tsx`

**変更内容:**
- `DateGroupedTodoList`コンポーネントに`timecardData`プロパティを追加で渡す

#### 3. View層: 棒グラフに稼働時間の縦棒を表示

**ファイル:** `src/components/TaskExecutionStackBar.tsx`

**追加するprops:**
- `timecardData: TimecardData`を追加

**変更内容:**
- `TaskExecutionStackBar`コンポーネントで、propsからtimecardDataを受け取る
- `TimecardRepository.calculateWorkingTimeForDate()`を呼び出して稼働時間を計算
- 稼働時間が0より大きい場合のみ、縦棒を表示
- 縦棒の位置は、稼働時間を基に`displayMaxMinutes`からパーセンテージで計算
- 縦棒は`.stackbar-scale-marker`と同じ位置計算ロジックを使用

**CSS変更:**

**ファイル:** `src/components/TaskExecutionStackBar.css`

**追加するスタイル:**
- `.stackbar-working-time-marker`: 稼働時間を示す縦棒のスタイル
  - 既存の`.stackbar-scale-marker`と類似した構造
  - 縦線を赤色（または目立つ色）で表示
  - 線の高さを棒グラフ全体を貫くように調整

#### 4. View層: DateGroupedTodoListからTaskExecutionStackBarへの受け渡し

**ファイル:** `src/components/DateGroupedTodoList.tsx`

**変更内容:**
- `TaskExecutionStackBar`コンポーネントに`timecardData={timecardData}`を渡す

## 実装順序

1. **Model層の実装:**
   - `TimecardRepository.calculateWorkingTimeForDate()`を実装
   - テストケースを追加

2. **View層のprops追加:**
   - `DateGroupedTodoList`のpropsに`timecardData`を追加
   - `App.tsx`から`timecardData`を渡す

3. **View層の縦棒表示:**
   - `TaskExecutionStackBar`のpropsに`timecardData`を追加
   - 稼働時間を計算し、縦棒を表示
   - CSSスタイルを追加

4. **統合とテスト:**
   - DateGroupedTodoListからTaskExecutionStackBarへtimecardDataを渡す
   - 動作確認

## 考慮事項

### エッジケース

- **稼働時間が0の場合**: 縦棒を表示しない（要件に従い特別な処理なし）
- **タイムカードエントリが奇数の場合**: 最後のstartエントリは無視（ペアになっていない）
- **日付にタイムカードデータが存在しない場合**: 稼働時間0として扱う

### UI/UX

- **縦棒の色**: 赤色など目立つ色を使用（Todoの色とは区別）
- **縦棒の太さ**: 時間目盛の線よりも太く、視認性を確保
- **ホバー時の情報表示**: 縦棒にホバーした際に稼働時間（例: "8.5h"）を表示

### パフォーマンス

- タイムカードデータの計算は軽量（日付ごとに最大数十エントリ程度）
- 既存の棒グラフのレンダリング処理に影響を与えない

## 関連ファイル一覧

### 変更が必要なファイル

1. `src/models/TimecardRepository.ts` - 稼働時間計算ロジックを追加
2. `src/models/TimecardRepository.test.ts` - テストケースを追加
3. `src/components/TaskExecutionStackBar.tsx` - 縦棒表示を追加
4. `src/components/TaskExecutionStackBar.css` - 縦棒のスタイルを追加
5. `src/components/DateGroupedTodoList.tsx` - timecardDataをpropsに追加
6. `src/App.tsx` - DateGroupedTodoListにtimecardDataを渡す

### 参照するファイル（変更不要）

- `src/models/TimecardEntry.ts` - TimecardEntryの構造を理解
- `src/hooks/useTimecard.ts` - タイムカードデータの取得方法を理解
- `src/utils/taskExecutionTime.ts` - 棒グラフの表示ロジックを参考
- `src/utils/timeFormat.ts` - 時刻のパース処理を参考

## 実装後の検証項目

1. 稼働時間が正しく計算されているか（手動で時間差を計算して確認）
2. 縦棒が正しい位置に表示されているか
3. 稼働時間が0の場合、縦棒が表示されないか
4. 複数のstart-endペアで稼働時間が合計されているか
5. ペアになっていないstartが無視されているか
6. UIが既存の棒グラフと調和しているか

## 備考

- この機能はIssue #0031の要件のみを実装します
- リファクタリングや最適化は含みません
- 既存の棒グラフの動作に影響を与えないよう注意します
