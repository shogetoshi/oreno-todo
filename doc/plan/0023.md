# Issue #0023: タイムカードのAPI操作 実装計画書

## 要件

1. タイムカードのチェックイン/アウトをAPIから実行できるようにする
2. 現在進行中のtodoがあれば停止するのもAPIからできるようにする

## 現状分析

### 既存のタイムカード実装

#### Model層
- `TimecardEntry`: 単一のタイムカードエントリ（start/end）
- `TimecardRepository`: タイムカードデータの管理
  - `addCheckIn()`: チェックイン追加
  - `addCheckOut()`: チェックアウト追加
  - データ構造: `{ [date: string]: TimecardEntry[] }`

#### Controller層
- `useTimecard`: タイムカード状態管理フック
  - `checkIn()`: チェックイン実行
  - `checkOut()`: チェックアウト実行
  - IPC通信: `loadTimecard`, `saveTimecard`

#### View層
- `TimecardPanel`: チェックイン/アウトボタンUI

#### IPC通信
- **型定義**: `src/types/electron.d.ts`
  - `loadTimecard()`, `saveTimecard()`
- **Preload**: `electron/preload.ts`
  - `ipcRenderer.invoke('load-timecard')`
  - `ipcRenderer.invoke('save-timecard', data)`
- **Main Process**: `electron/main.ts`
  - `ipcMain.handle('load-timecard', ...)`
  - `ipcMain.handle('save-timecard', ...)`
  - ファイルパス: `timecard.json`

### 既存のAPI実装パターン

#### TODO追加API (`POST /api/todos`)
- **Main Process** (`electron/main.ts:134-154`):
  1. HTTPリクエストを受信
  2. バリデーション実施
  3. 全ウィンドウに`add-todo-request`イベントを送信
- **Preload** (`electron/preload.ts:7-9`):
  - `onAddTodoRequest`: `ipcRenderer.on('add-todo-request', ...)`
- **Controller** (`src/hooks/useTodos.ts:57-61`):
  - `useEffect`で`onAddTodoRequest`をリスン
  - `addTodo()`を呼び出し
- **フロー**: HTTP → Main → IPC Event → Preload → Controller → Model → UI更新

### Todo停止機能の確認

#### 既存実装
- `useTodos.ts:106-108`: `stopTimer(id)`
- `TodoRepository.ts:119-123`: `stopItemTimer(items, id)`
- 指定IDのTodoのタイマーを停止

#### 現在進行中のTodo検出
- `TodoRepository`には「現在進行中のTodo」を検出するメソッドが存在しない
- 実装が必要: `findRunningItem(items: ListItem[]): ListItem | null`

## 実装設計

### 1. API エンドポイント設計

#### 1.1. タイムカードチェックインAPI
```
POST /api/timecard/check-in
Body: {}
Response: { success: true } | { success: false, error: string }
```

#### 1.2. タイムカードチェックアウトAPI
```
POST /api/timecard/check-out
Body: {}
Response: { success: true } | { success: false, error: string }
```

#### 1.3. 進行中のTodo停止API
```
POST /api/todos/stop-running
Body: {}
Response: { success: true, stoppedTodoId?: string } | { success: false, error: string }
```

### 2. 実装ステップ

#### Step 1: Model層の拡張
**ファイル**: `src/models/TodoRepository.ts`

**追加メソッド**:
```typescript
/**
 * 現在進行中のListItem（タイマーが開始されているもの）を検索する
 * @param items ListItemリスト
 * @returns 進行中のListItem、見つからない場合はnull
 */
static findRunningItem(items: ListItem[]): ListItem | null

/**
 * 現在進行中のすべてのListItemのタイマーを停止する
 * @param items ListItemリスト
 * @returns 新しいListItemリスト
 */
static stopAllRunningItems(items: ListItem[]): ListItem[]
```

**テストファイル**: `src/models/TodoRepository.test.ts`
- `findRunningItem`の単体テスト追加
- `stopAllRunningItems`の単体テスト追加

#### Step 2: Controller層の拡張
**ファイル**: `src/hooks/useTodos.ts`

**追加関数**:
```typescript
// 現在進行中のTodoを停止する
const stopRunningTodo = useCallback(() => {
  setTodosWithPersist((prev) => TodoRepository.stopAllRunningItems(prev));
}, [setTodosWithPersist]);

// HTTPサーバー経由の停止リクエストを受信
useEffect(() => {
  window.electronAPI.onStopRunningTodoRequest(() => {
    stopRunningTodo();
  });
}, [stopRunningTodo]);
```

**ファイル**: `src/hooks/useTimecard.ts`

**追加関数**:
```typescript
// HTTPサーバー経由のチェックインリクエストを受信
useEffect(() => {
  window.electronAPI.onCheckInRequest(() => {
    checkIn();
  });
}, [checkIn]);

// HTTPサーバー経由のチェックアウトリクエストを受信
useEffect(() => {
  window.electronAPI.onCheckOutRequest(() => {
    checkOut();
  });
}, [checkOut]);
```

#### Step 3: IPC通信の追加

**ファイル**: `src/types/electron.d.ts`

**追加型定義**:
```typescript
export interface ElectronAPI {
  // ... 既存のメソッド
  onCheckInRequest: (callback: () => void) => void;
  onCheckOutRequest: (callback: () => void) => void;
  onStopRunningTodoRequest: (callback: () => void) => void;
}
```

**ファイル**: `electron/preload.ts`

**追加実装**:
```typescript
const electronAPI: ElectronAPI = {
  // ... 既存のメソッド
  onCheckInRequest: (callback) => {
    ipcRenderer.on('check-in-request', () => callback());
  },
  onCheckOutRequest: (callback) => {
    ipcRenderer.on('check-out-request', () => callback());
  },
  onStopRunningTodoRequest: (callback) => {
    ipcRenderer.on('stop-running-todo-request', () => callback());
  },
};
```

**ファイル**: `electron/main.ts`

**追加実装**:
```typescript
// タイムカードチェックインAPI
httpApp.post('/api/timecard/check-in', (_req, res) => {
  // 全てのウィンドウにイベントを送信
  const windows = BrowserWindow.getAllWindows();
  windows.forEach(window => {
    window.webContents.send('check-in-request');
  });
  res.json({ success: true });
});

// タイムカードチェックアウトAPI
httpApp.post('/api/timecard/check-out', (_req, res) => {
  // 全てのウィンドウにイベントを送信
  const windows = BrowserWindow.getAllWindows();
  windows.forEach(window => {
    window.webContents.send('check-out-request');
  });
  res.json({ success: true });
});

// 進行中のTodo停止API
httpApp.post('/api/todos/stop-running', (_req, res) => {
  // 全てのウィンドウにイベントを送信
  const windows = BrowserWindow.getAllWindows();
  windows.forEach(window => {
    window.webContents.send('stop-running-todo-request');
  });
  res.json({ success: true });
});
```

#### Step 4: テストの更新

**追加テスト**:
1. `src/models/TodoRepository.test.ts`
   - `findRunningItem`: タイマー実行中のTodoを正しく検出できるか
   - `findRunningItem`: タイマー実行中のTodoがない場合nullを返すか
   - `stopAllRunningItems`: すべての実行中タイマーを停止できるか
   - `stopAllRunningItems`: 実行中タイマーがない場合は変更しないか

**統合テスト（手動）**:
1. `POST /api/timecard/check-in` → タイムカードにチェックイン記録が追加される
2. `POST /api/timecard/check-out` → タイムカードにチェックアウト記録が追加される
3. Todoタイマーを起動 → `POST /api/todos/stop-running` → タイマーが停止する
4. タイマー起動なし → `POST /api/todos/stop-running` → エラーなく完了

#### Step 5: ドキュメントの更新

**更新ファイル**:
1. `CLAUDE.md`: 新しいAPIエンドポイントの情報を追加
2. `docs/MVC-ARCHITECTURE.md`: `TodoRepository`の新メソッド追加を記載

## データフロー図

### タイムカードチェックインAPI
```
HTTP POST /api/timecard/check-in
  ↓
electron/main.ts (バリデーション不要)
  ↓
BrowserWindow.send('check-in-request')
  ↓
electron/preload.ts (ipcRenderer.on)
  ↓
useTimecard.onCheckInRequest
  ↓
useTimecard.checkIn()
  ↓
TimecardRepository.addCheckIn()
  ↓
UI更新 + IPC保存 (save-timecard)
```

### 進行中のTodo停止API
```
HTTP POST /api/todos/stop-running
  ↓
electron/main.ts (バリデーション不要)
  ↓
BrowserWindow.send('stop-running-todo-request')
  ↓
electron/preload.ts (ipcRenderer.on)
  ↓
useTodos.onStopRunningTodoRequest
  ↓
useTodos.stopRunningTodo()
  ↓
TodoRepository.stopAllRunningItems()
  ↓
UI更新 + IPC保存 (save-todos)
```

## 注意事項

1. **バリデーション**: タイムカードチェックイン/アウトはリクエストボディが空なのでバリデーション不要
2. **エラーハンドリング**: IPC通信エラーは既存の楽観的更新パターンでカバー済み
3. **後方互換性**: 破壊的変更なし（新機能追加のみ）
4. **セキュリティ**: ローカルホストのみアクセス可能（既存実装と同様）

## 実装順序

1. Model層の拡張（TodoRepository）+ テスト
2. Controller層の拡張（useTodos, useTimecard）
3. IPC通信の追加（型定義 → preload → main）
4. 統合テスト（手動）
5. ドキュメント更新

## 見積もり

- Model層: 30分
- Controller層: 20分
- IPC通信: 30分
- テスト: 30分
- ドキュメント: 10分

**合計**: 約2時間
