# Issue #0044: 一番上に追加 実装計画書

## 要件

- Todoが追加されたらリストの一番上に表示されるようにする
  - UIから追加した時も、APIから追加された時も
  - 共通の処理になっているはずだから1箇所しか変更しない認識

## 重要な制約

1. 共通処理を見つけて、その1箇所のみを変更すること
2. MVCアーキテクチャに従う (Model層 → TodoRepository)
3. 最小限の変更で実現すること

---

## 現状分析

### 現在のTodo追加フロー

#### Model層
**ファイル**: `src/models/TodoRepository.ts`

```typescript
// 35-38行目
static addTodo(todos: Todo[], taskcode: string, text: string): Todo[] {
  const newTodo = this.createTodo(taskcode, text);
  return [...todos, newTodo];  // 末尾に追加
}
```

#### Controller層
**ファイル**: `src/hooks/useTodos.ts`

```typescript
// 54-56行目
const addTodo = useCallback((taskcode: string, text: string) => {
  setTodosWithPersist((prev) => [...prev, TodoRepository.createTodo(taskcode, text)]);
}, [setTodosWithPersist]);
```

**注意**: `useTodos.ts`の`addTodo`は直接`TodoRepository.createTodo()`を呼び出しており、`TodoRepository.addTodo()`を使用していません。

#### View層
**ファイル**: `src/App.tsx`

```typescript
// TodoInputコンポーネント経由で呼び出し
<TodoInput onAdd={addTodo} />
```

### API経由のTodo追加

**ファイル**: `electron/main.ts` (HTTP APIハンドラー)

```typescript
app.post('/api/todos', async (req, res) => {
  try {
    const { taskcode, text } = req.body;
    mainWindow?.webContents.send('add-todo-request', taskcode, text);
    res.json({ success: true });
  } catch (error) {
    res.status(500).json({ success: false, error: error.message });
  }
});
```

**ファイル**: `src/hooks/useTodos.ts`

```typescript
// 59-63行目
useEffect(() => {
  window.electronAPI.onAddTodoRequest((taskcode: string, text: string) => {
    addTodo(taskcode, text);  // 同じaddTodo関数を呼び出し
  });
}, [addTodo]);
```

### クイックタスク追加（既に先頭に追加している実装）

**ファイル**: `src/hooks/useTodos.ts`

```typescript
// 150-157行目
const addQuickTask = useCallback(() => {
  setTodosWithPersist((prev) => {
    const currentTime = getCurrentJSTTime();
    const newTodo = TodoRepository.createTodo('', currentTime);
    const todoWithTimer = newTodo.startTimer();
    return [todoWithTimer, ...prev];  // 先頭に追加
  });
}, [setTodosWithPersist]);
```

**ポイント**: クイックタスクは既に`[todoWithTimer, ...prev]`で先頭に追加している。これと同じ動作を通常のTodo追加にも適用する必要がある。

---

## 問題点の特定

### 共通処理はどこか？

**UI追加**と**API追加**は、どちらも`useTodos.ts`の`addTodo`関数を呼び出しています。

```typescript
// UI追加
<TodoInput onAdd={addTodo} />

// API追加
window.electronAPI.onAddTodoRequest((taskcode, text) => {
  addTodo(taskcode, text);
});
```

**共通処理**: `useTodos.ts`の`addTodo`関数が共通のエントリーポイントです。

### 現在の実装の問題

```typescript
// useTodos.ts 54-56行目
const addTodo = useCallback((taskcode: string, text: string) => {
  setTodosWithPersist((prev) => [...prev, TodoRepository.createTodo(taskcode, text)]);
  //                              ^^^^^^^^ 末尾に追加
}, [setTodosWithPersist]);
```

- `[...prev, newTodo]`は末尾に追加
- **修正**: `[newTodo, ...prev]`に変更することで先頭に追加

### TodoRepository.addTodo()は使用されていない

`TodoRepository.addTodo()`メソッドは定義されていますが、実際には使用されていません。

**使用箇所の検証**:
- `useTodos.ts`: 使用していない（直接`createTodo()`を呼び出している）
- その他のファイル: 使用されていない

**結論**: `TodoRepository.addTodo()`を修正しても効果はありません。`useTodos.ts`の`addTodo`関数を修正する必要があります。

---

## 実装設計

### 修正方針

1. **修正箇所**: `src/hooks/useTodos.ts`の`addTodo`関数（54-56行目）
2. **修正内容**: 末尾追加(`[...prev, newTodo]`)を先頭追加(`[newTodo, ...prev]`)に変更
3. **影響範囲**:
   - UIからの追加（TodoInput経由）
   - APIからの追加（HTTP API経由）

### MVCアーキテクチャへの影響

#### Model層
- **変更なし**: `TodoRepository`への変更は不要
- `TodoRepository.createTodo()`は引き続き使用

#### Controller層
- **修正あり**: `useTodos.ts`の`addTodo`関数を修正
- 配列の追加位置を先頭に変更するだけ

#### View層
- **変更なし**: `App.tsx`, `TodoInput.tsx`への変更は不要

### コード修正

**ファイル**: `src/hooks/useTodos.ts`

**修正前** (54-56行目):
```typescript
const addTodo = useCallback((taskcode: string, text: string) => {
  setTodosWithPersist((prev) => [...prev, TodoRepository.createTodo(taskcode, text)]);
}, [setTodosWithPersist]);
```

**修正後**:
```typescript
const addTodo = useCallback((taskcode: string, text: string) => {
  setTodosWithPersist((prev) => [TodoRepository.createTodo(taskcode, text), ...prev]);
}, [setTodosWithPersist]);
```

**変更点**: `[...prev, newTodo]` → `[newTodo, ...prev]`

---

## データフロー（修正後）

### UI経由のTodo追加
```
ユーザーがTodoInputで追加ボタンをクリック
  ↓
App.tsx: onAdd={addTodo}
  ↓
useTodos.ts: addTodo(taskcode, text)
  ↓
TodoRepository.createTodo(taskcode, text)
  ↓
[newTodo, ...prev] で先頭に追加
  ↓
setTodosWithPersist()で永続化
  ↓
UI更新: 新しいTodoがリストの先頭に表示
```

### API経由のTodo追加
```
HTTP POST /api/todos
  ↓
electron/main.ts: mainWindow.webContents.send('add-todo-request', taskcode, text)
  ↓
useTodos.ts: onAddTodoRequest()
  ↓
useTodos.ts: addTodo(taskcode, text)
  ↓
（以下、UI経由と同じフロー）
```

---

## テスト戦略

### 手動テスト

#### 1. UI経由の追加
1. TodoInputに「テスト1」と入力して追加
2. 「テスト2」と入力して追加
3. リストの先頭に「テスト2」、その下に「テスト1」が表示されることを確認

#### 2. API経由の追加
```bash
curl -X POST http://localhost:3000/api/todos \
  -H "Content-Type: application/json" \
  -d '{"taskcode": "API-001", "text": "API経由のテスト1"}'

curl -X POST http://localhost:3000/api/todos \
  -H "Content-Type: application/json" \
  -d '{"taskcode": "API-002", "text": "API経由のテスト2"}'
```

期待結果:
- リストの先頭に「API経由のテスト2」が表示される
- その下に「API経由のテスト1」が表示される

#### 3. UI + API混合
1. UIで「UI-1」を追加
2. APIで「API-1」を追加
3. UIで「UI-2」を追加

期待結果:
```
UI-2      ← 最後に追加
API-1
UI-1      ← 最初に追加
```

#### 4. クイックタスクとの併用
1. クイックタスクボタンをクリック
2. UIで通常のTodoを追加

期待結果:
- どちらも先頭に追加される（新しい方が上に来る）

#### 5. 永続化の確認
1. 複数のTodoを追加
2. アプリを再起動
3. Todoの順序が保持されていることを確認

### 単体テスト（オプション）

既存の`TodoRepository.test.ts`にテストケースを追加する場合:

```typescript
describe('Todo追加順序', () => {
  it('新しいTodoが先頭に追加される', () => {
    const todos: Todo[] = [];
    const todo1 = TodoRepository.createTodo('TASK-001', 'タスク1');
    const todos1 = [todo1];

    const todo2 = TodoRepository.createTodo('TASK-002', 'タスク2');
    const todos2 = [todo2, ...todos1];

    expect(todos2[0].text).toBe('タスク2');
    expect(todos2[1].text).toBe('タスク1');
  });
});
```

**注意**: 単体テストは必須ではありません。手動テストで十分です。

---

## 実装ステップ

### Step 1: コード修正
1. `src/hooks/useTodos.ts`を開く
2. 54-56行目の`addTodo`関数を修正
3. `[...prev, TodoRepository.createTodo(taskcode, text)]` → `[TodoRepository.createTodo(taskcode, text), ...prev]`

### Step 2: 動作確認
1. 開発サーバーを起動 (`pnpm run electron:dev`)
2. 手動テストケース1-5を実行
3. すべてのケースで先頭に追加されることを確認

### Step 3: コミット
```bash
git add src/hooks/useTodos.ts
git commit -m "feat: Issue #0044 一番上に追加 - Todoを先頭に追加するように変更"
```

---

## 影響範囲の検証

### 変更されるファイル
- `src/hooks/useTodos.ts` (1箇所のみ)

### 変更されないファイル
- `src/models/TodoRepository.ts`
- `src/App.tsx`
- `src/components/TodoInput.tsx`
- `electron/main.ts`

### 既存機能への影響
- **Todo追加**: 先頭に追加されるように変更（破壊的変更）
- **Todo編集、削除**: 影響なし
- **タイマー機能**: 影響なし
- **並び替え機能**: 影響なし
- **永続化**: 影響なし

---

## 補足: TodoRepository.addTodo()の取り扱い

`TodoRepository.addTodo()`メソッドは現在使用されていませんが、将来的に使用する可能性を考慮して、同時に修正しておくことも検討できます。

**修正案** (`src/models/TodoRepository.ts` 35-38行目):
```typescript
static addTodo(todos: Todo[], taskcode: string, text: string): Todo[] {
  const newTodo = this.createTodo(taskcode, text);
  return [newTodo, ...todos];  // 先頭に追加
}
```

**判断**:
- **修正する**: 一貫性を保つため、将来的なバグを防ぐ
- **修正しない**: 使用されていないコードを修正する必要はない（YAGNI原則）

**推奨**: 一貫性のために修正しておく（2箇所の変更になる）

---

## 見積もり

- コード修正: 5分
- 動作確認（手動テスト）: 15分
- コミット: 5分

**合計**: 約25分

---

## 設計の根拠

### なぜController層を修正するのか

- `addTodo`関数がUIとAPIの共通エントリーポイント
- 1箇所の修正で両方の追加方法に影響する
- MVCアーキテクチャの責務に沿った修正

### なぜModel層を修正しないのか

- `TodoRepository.addTodo()`は使用されていない
- 使用されているのは`TodoRepository.createTodo()`のみ
- 配列への追加はController層で行っている

### クイックタスクとの一貫性

クイックタスクは既に先頭追加を実装しています:
```typescript
return [todoWithTimer, ...prev];
```

通常のTodo追加も同じ動作にすることで、ユーザーエクスペリエンスが一貫します。

---

## 注意事項

1. **破壊的変更**: Todoの追加順序が変わるため、既存のユーザーにとっては動作が変わります
2. **後方互換性**: 既存のデータには影響しません（既存のTodoの順序は保持されます）
3. **ドラッグ&ドロップ**: 手動で並び替える機能には影響しません

---

## 実装完了後の確認事項

- [ ] UIからの追加が先頭に追加される
- [ ] APIからの追加が先頭に追加される
- [ ] クイックタスクが先頭に追加される（既存動作の維持）
- [ ] 複数回追加した場合、最新のものが最上部に来る
- [ ] アプリ再起動後も順序が保持される
- [ ] ドラッグ&ドロップで並び替えができる（既存機能の維持）
