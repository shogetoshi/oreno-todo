# Issue #0028: 予定取得ボタンを日付ごとに

## Issue概要

現在、Googleカレンダーからの予定取得ボタンは画面上部に1つだけ配置されており、今日の予定のみを取得します。
この機能を拡張し、日付枠ごとに予定取得ボタンを配置し、その日付の予定だけを取得できるようにします。

## 現状分析

### 既存の実装構造

**Model層:**
- `electron/googleCalendar.ts`: Google Calendar API連携ロジック
  - `fetchCalendarEvents(date: string)`: 指定日付のイベントを取得（既に日付パラメータ対応済み）
  - `getTodayDateString()`: 今日の日付をYYYY-MM-DD形式で取得

**Controller層:**
- `src/hooks/useTodos.ts`:
  - `importCalendarEvents(date?: string)`: IPC経由でカレンダーイベントを取得
  - dateパラメータは既にオプショナルで対応済み

**Infrastructure層:**
- `electron/main.ts`: IPCハンドラー
  - `ipcMain.handle('fetch-calendar-events', async (_, date?: string))`: 日付パラメータを受け取る（既に対応済み）
- `electron/preload.ts`: IPC API公開
  - `fetchCalendarEvents: (date) => ipcRenderer.invoke('fetch-calendar-events', date)`: 日付パラメータを渡す（既に対応済み）
- `src/types/electron.d.ts`: 型定義
  - `fetchCalendarEvents: (date?: string) => Promise<FetchCalendarEventsResult>`: 型定義済み

**View層:**
- `src/App.tsx`:
  - 画面上部に「カレンダーから取得」ボタンを配置
  - `handleImportCalendar()`: ボタン押下時、`importCalendarEvents()`を日付なしで呼び出し（今日の予定を取得）
- `src/components/DateGroupedTodoList.tsx`:
  - 日付枠（DateGroup）ごとにアイテムをグループ化して表示
  - 現在は予定取得ボタンなし

### 必要な変更点の特定

既存の実装は、Main Process（Google Calendar API）からController層まで日付パラメータに対応済みです。
そのため、**View層のみの変更**で要件を満たせます。

1. **View層の変更:**
   - `DateGroupedTodoList.tsx`: 各日付枠に「予定取得」ボタンを追加
   - `App.tsx`: `importCalendarEvents`関数をpropsとして`DateGroupedTodoList`に渡す

## 実装内容

### 1. `src/App.tsx`の変更

**変更内容:**
- `DateGroupedTodoList`コンポーネントに`onImportCalendarEvents`プロパティを追加し、`importCalendarEvents`関数を渡します

**理由:**
- View層の`DateGroupedTodoList`がController層の`importCalendarEvents`関数を呼び出せるようにするため

**具体的な変更:**
```tsx
<DateGroupedTodoList
  todos={todos}
  onToggle={toggleTodo}
  onDelete={deleteTodo}
  onEdit={editTodo}
  onEditTaskcode={editTaskcode}
  onReorder={reorderTodos}
  onStartTimer={startTimer}
  onStopTimer={stopTimer}
  onOpenJsonEditor={handleOpenSingleItemJsonEditor}
  onImportCalendarEvents={importCalendarEvents}  // 追加
/>
```

### 2. `src/components/DateGroupedTodoList.tsx`の変更

**変更内容:**
- propsに`onImportCalendarEvents: (date: string) => Promise<void>`を追加
- 各日付枠（DateGroup）のヘッダー部分に「予定取得」ボタンを追加
- ボタン押下時にローカル状態（isImporting、error）を管理し、`onImportCalendarEvents(group.date)`を呼び出す

**理由:**
- 日付枠ごとに予定取得を行うUIを提供するため
- ボタンの読み込み中状態とエラー表示は、日付枠ごとに独立して管理する必要があるため

**具体的な変更:**

1. propsインターフェースに追加:
```tsx
interface DateGroupedTodoListProps {
  // 既存のprops...
  onImportCalendarEvents: (date: string) => Promise<void>;
}
```

2. 日付ごとのローカル状態を管理するため、`useState`を使用:
```tsx
const [importingStates, setImportingStates] = useState<{[date: string]: boolean}>({});
const [errorStates, setErrorStates] = useState<{[date: string]: string | null}>({});
```

3. 予定取得ハンドラーを実装:
```tsx
const handleImportForDate = async (date: string) => {
  setImportingStates(prev => ({...prev, [date]: true}));
  setErrorStates(prev => ({...prev, [date]: null}));

  try {
    await onImportCalendarEvents(date);
  } catch (error) {
    setErrorStates(prev => ({
      ...prev,
      [date]: error instanceof Error ? error.message : 'カレンダーの取得に失敗しました'
    }));
  } finally {
    setImportingStates(prev => ({...prev, [date]: false}));
  }
};
```

4. 日付枠のヘッダー部分にボタンを追加:
```tsx
<div className="date-group-header-container">
  <h2 className="date-group-header">{group.displayDate}</h2>
  <button
    className="calendar-import-button-small"
    onClick={() => handleImportForDate(group.date)}
    disabled={importingStates[group.date]}
  >
    {importingStates[group.date] ? '取得中...' : '予定取得'}
  </button>
</div>
{errorStates[group.date] && (
  <div className="calendar-error-inline">
    <span>{errorStates[group.date]}</span>
    <button onClick={() => setErrorStates(prev => ({...prev, [group.date]: null}))}>×</button>
  </div>
)}
```

5. CSSクラスの追加（`src/App.css`）:
```css
.date-group-header-container {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
}

.calendar-import-button-small {
  padding: 4px 12px;
  font-size: 12px;
  background-color: #4a90e2;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  white-space: nowrap;
}

.calendar-import-button-small:hover {
  background-color: #357abd;
}

.calendar-import-button-small:disabled {
  background-color: #ccc;
  cursor: not-allowed;
}

.calendar-error-inline {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px;
  margin: 8px 0;
  background-color: #ffe6e6;
  border: 1px solid #ffcccc;
  border-radius: 4px;
  font-size: 13px;
  color: #cc0000;
}

.calendar-error-inline button {
  background: none;
  border: none;
  font-size: 16px;
  color: #cc0000;
  cursor: pointer;
  padding: 0 4px;
}
```

## 変更順序と依存関係

1. **Step 1**: `src/App.tsx`を変更（propsの追加）
2. **Step 2**: `src/components/DateGroupedTodoList.tsx`を変更（ボタン追加とハンドラー実装）
3. **Step 3**: `src/App.css`にCSSスタイルを追加

依存関係: Step 1 → Step 2（App.tsxからpropsを渡す必要があるため）

## 考慮事項

### MVCアーキテクチャの遵守

- **View層のみの変更**: Model層やController層のロジックは一切変更しません
- **ローカルUI状態の管理**: ボタンの読み込み中状態とエラー表示は、View層のローカル状態として管理します
- **Controllerへの委譲**: 予定取得のビジネスロジックは、Controller層の`importCalendarEvents`関数に委譲します

### 既存機能への影響

- 画面上部の「カレンダーから取得」ボタンは残します（今日の予定を一括取得する便利機能として）
- 既存のIPC通信、Google Calendar API連携は変更不要です

### エラーハンドリング

- 各日付枠ごとに独立したエラー表示を行います
- エラーメッセージは×ボタンで閉じられます
- 取得中は他の日付のボタンも押せます（並行取得可能）

### UI/UX

- ボタンは日付枠のヘッダー右側に配置（日付と並列）
- ボタンサイズは小さめにし、視覚的な邪魔にならないようにします
- 取得中は「取得中...」と表示し、ボタンを無効化します

## テスト方針

### 手動テスト

1. 各日付枠の「予定取得」ボタンを押下し、その日付の予定のみが取得されることを確認
2. 複数の日付で並行して予定取得を実行し、それぞれが独立して動作することを確認
3. エラー発生時にエラーメッセージが表示され、×ボタンで閉じられることを確認
4. 画面上部の既存の「カレンダーから取得」ボタンも引き続き動作することを確認

### 単体テスト（オプション）

- `DateGroupedTodoList.tsx`のコンポーネントテスト
  - ボタンのレンダリング確認
  - ボタン押下時に`onImportCalendarEvents`が正しい日付パラメータで呼ばれることを確認
  - エラー表示とクリア機能の確認

## 変更ファイル一覧

- `src/App.tsx`: propsの追加
- `src/components/DateGroupedTodoList.tsx`: ボタン追加とハンドラー実装
- `src/App.css`: CSSスタイル追加

## 備考

- 既存の実装が日付パラメータに対応済みだったため、View層のみの変更で済みます
- 最小限の変更で要件を満たすことができます
- MVCアーキテクチャに完全に準拠した実装です
