# Issue 0026: カレンダーイベントが表示されない - 実装計画

## 問題の概要

スケジュールイベントがstartTimeの日付の枠に表示されなくなっている。
原因は、startTime/endTimeが想定される日時フォーマット（`YYYY-MM-DD HH:MI:SS` JST）ではなく、
Googleカレンダーから取得したISO 8601形式（例: `2023-11-01T10:00:00+09:00`）のままになっているため。

## 根本原因の詳細分析

### 1. フォーマット変換が欠落している箇所

**CalendarEvent.ts (`extractStartTimeFromGoogleEvent` / `extractEndTimeFromGoogleEvent`)**
- 現状: GoogleカレンダーのISO 8601形式をそのまま返している
  ```typescript
  private static extractStartTimeFromGoogleEvent(event: CalendarEventType): string | null {
    return event.start.dateTime || event.start.date || null;
  }
  ```
- 問題: `event.start.dateTime`は`2023-11-01T10:00:00+09:00`の形式
- 必要な形式: `2023-11-01 10:00:00` (JST)

**CalendarEvent.ts (`extractCreatedAtFromGoogleEvent` / `extractUpdatedAtFromGoogleEvent`)**
- 現状: `toISOString()`を使用しており、ISO 8601 UTC形式（例: `2023-10-20T09:00:00.000Z`）を返している
  ```typescript
  private static extractCreatedAtFromGoogleEvent(event: CalendarEventType): string {
    return new Date(event.created).toISOString();
  }
  ```
- 必要な形式: `2023-10-20 18:00:00` (JST) ※UTC+9時間変換

### 2. 日付抽出関数の互換性問題

**timeFormat.ts (`extractDateFromJST`)**
- 現状: スペース区切りの日時文字列のみに対応
  ```typescript
  export function extractDateFromJST(jstString: string): string {
    if (jstString.includes(' ')) {
      return jstString.split(' ')[0];
    }
    return jstString;
  }
  ```
- 問題: ISO 8601形式（`T`区切り）には対応していない
- 影響: `TodoRepository.shouldDisplayOnDate`でカレンダーイベントのstartTimeから日付を抽出する際に、全文字列が返されてしまう
  - 入力: `2023-11-01T10:00:00+09:00`
  - 期待: `2023-11-01`
  - 実際: `2023-11-01T10:00:00+09:00` ← 日付比較が失敗

### 3. テストカバレッジの不足

- `CalendarEvent.fromGoogleCalendarEvent`のテストでは、startTime/endTimeのフォーマットを検証していない
- `TodoRepository.shouldDisplayOnDate`のカレンダーイベントに関するテストが存在しない
- ISO 8601形式からJSTフォーマットへの変換テストが存在しない

## 修正計画

### Phase 1: ユーティリティ関数の拡張（timeFormat.ts）

#### 1.1 ISO 8601形式をJSTフォーマットに変換する関数の追加

新しい関数を追加:
```typescript
/**
 * ISO 8601形式の日時文字列をJSTフォーマット（"YYYY-MM-DD HH:MI:SS"）に変換
 * @param isoString ISO 8601形式の日時文字列
 *   - 例: "2023-11-01T10:00:00+09:00"
 *   - 例: "2023-10-20T09:00:00.000Z"
 *   - 例: "2023-11-05" (日付のみ)
 * @returns JST日時文字列（"YYYY-MM-DD HH:MI:SS"）
 *   - 日付のみの場合は "YYYY-MM-DD 00:00:00" を返す
 */
export function convertISOToJST(isoString: string): string
```

実装方針:
1. `Date`コンストラクタでISO 8601文字列をパース
2. `formatToJST()`を使用してJSTフォーマットに変換
3. 日付のみの場合（終日イベント用）は `00:00:00` を時刻として付与

#### 1.2 extractDateFromJSTの修正

ISO 8601形式にも対応させる:
```typescript
export function extractDateFromJST(jstString: string): string {
  if (jstString.includes(' ')) {
    return jstString.split(' ')[0];
  }
  // ISO 8601形式（T区切り）にも対応
  if (jstString.includes('T')) {
    return jstString.split('T')[0];
  }
  return jstString;
}
```

### Phase 2: CalendarEventの修正

#### 2.1 extractStartTimeFromGoogleEventの修正

```typescript
private static extractStartTimeFromGoogleEvent(event: CalendarEventType): string | null {
  const rawTime = event.start.dateTime || event.start.date;
  if (!rawTime) {
    return null;
  }
  return convertISOToJST(rawTime);
}
```

#### 2.2 extractEndTimeFromGoogleEventの修正

```typescript
private static extractEndTimeFromGoogleEvent(event: CalendarEventType): string | null {
  const rawTime = event.end.dateTime || event.end.date;
  if (!rawTime) {
    return null;
  }
  return convertISOToJST(rawTime);
}
```

#### 2.3 extractCreatedAtFromGoogleEventの修正

```typescript
private static extractCreatedAtFromGoogleEvent(event: CalendarEventType): string {
  return convertISOToJST(event.created);
}
```

#### 2.4 extractUpdatedAtFromGoogleEventの修正

```typescript
private static extractUpdatedAtFromGoogleEvent(event: CalendarEventType): string {
  return convertISOToJST(event.updated);
}
```

### Phase 3: テストの追加・更新

#### 3.1 timeFormat.test.tsにconvertISOToJSTのテストを追加

- ISO 8601日時形式（タイムゾーン付き）からの変換
- ISO 8601 UTC形式からの変換
- 日付のみ（終日イベント）の変換
- 往復変換テスト（convertISOToJST → parseJSTString → formatToJST）

#### 3.2 timeFormat.test.tsにextractDateFromJSTのISO 8601対応テストを追加

- ISO 8601形式からの日付抽出
- 既存のJSTフォーマットとの互換性確認

#### 3.3 CalendarEvent.test.tsにフォーマット検証テストを追加

- `fromGoogleCalendarEvent`のstartTime/endTimeがJSTフォーマットであることを検証
- createdAt/updatedAtがJSTフォーマットであることを検証
- 終日イベント（dateのみ）の変換を検証

#### 3.4 TodoRepository.test.tsにshouldDisplayOnDateのカレンダーイベントテストを追加

- startTimeがJSTフォーマットの場合の正常動作
- 日付が一致するカレンダーイベントは表示される
- 日付が一致しないカレンダーイベントは表示されない
- startTimeがnullの場合は表示されない

## 実装順序

1. **timeFormat.ts**
   - `convertISOToJST`関数の追加
   - `extractDateFromJST`の修正

2. **timeFormat.test.ts**
   - 新規関数・修正関数のテスト追加

3. **CalendarEvent.ts**
   - 4つのextract系メソッドの修正

4. **CalendarEvent.test.ts**
   - フォーマット検証テストの追加

5. **TodoRepository.test.ts**
   - `shouldDisplayOnDate`のカレンダーイベントテストの追加

6. **統合テスト**
   - 全テストの実行と確認
   - カレンダーサンプルデータでの動作確認

## 期待される効果

- カレンダーイベントが正しい日付枠に表示される
- 全ての日時データがJSTフォーマット（`YYYY-MM-DD HH:MI:SS`）で統一される
- JSONファイルのフォーマットが統一され、データの可読性が向上
- テストカバレッジが向上し、将来の回帰を防止

## 注意事項

- 既存のtodos.jsonにISO 8601形式のカレンダーイベントが保存されている場合、`fromJSON`経由での読み込みではフォーマット変換が行われない
  - これらのイベントは次回の「カレンダーから取得」操作で正しいフォーマットに置き換えられる
  - または、JSON編集機能で手動修正が必要
- 後方互換性のため、`extractDateFromJST`は既存のJSTフォーマットとISO 8601形式の両方に対応
